<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 登录回调</title>
    <script src="auth.js"></script>
    <script>
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 初始化认证服务
                const authService = new AuthService();
                await authService.init();
                console.log('认证服务初始化成功');

                // 检查是否有会话令牌
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                if (token) {
                    console.log('会话令牌有效，正在验证...');
                    // 存储会话令牌
                    localStorage.setItem('authToken', token);

                    // 验证令牌并获取用户信息
                    try {
                        const response = await fetch(
                            authService.githubConfig.apiBaseUrl ? `${authService.githubConfig.apiBaseUrl}/auth/me` : 'http://localhost:8787/auth/me',
                            {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            }
                        );

                        if (!response.ok) {
                            throw new Error(`验证失败: ${response.status} ${response.statusText}`);
                        }

                        const user = await response.json();
                        console.log('获取用户信息成功:', user);
                        authService.user = user;
                        localStorage.setItem('githubUserInfo', JSON.stringify(user));

                        // 登录成功后重定向到主页
                        window.location.href = '/';
                    } catch (error) {
                        console.error('验证令牌失败:', error);
                        document.getElementById('message').textContent = '登录失败: 无法验证会话';
                    }
                } else {
                    console.error('没有找到会话令牌');
                    document.getElementById('message').textContent = '登录失败: 无效的请求';
                }
            } catch (error) {
                console.error('处理登录回调失败:', error);
                document.getElementById('message').textContent = '登录失败: ' + error.message;
            }
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .loading {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #message {
            color: #333;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading"></div>
        <p id="message">正在处理登录，请稍候...</p>
    </div>
</body>
</html>